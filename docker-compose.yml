version: '3.8'

services:
  # Laravel PHP-FPM Service
  laravel_app:
    build:
      context: ./vue-reverb-integration
      dockerfile: Dockerfile.laravel
    container_name: laravel_app
    # We don't expose 9000 to the host as Nginx will handle routing to it
    volumes:
      - ./vue-reverb-integration:/var/www/html
    environment:
      # Inherit common variables from the .env file in the same directory as docker-compose.yml
      APP_KEY: ${APP_KEY}
      APP_DEBUG: ${APP_DEBUG}
      # Database: Using SQLite, file will be in the volume mount
      DB_CONNECTION: sqlite
      DB_DATABASE: /var/www/html/database/database.sqlite
      # Laravel App URLs
      APP_URL: http://${APP_HOST:-project.test} # Can be configured via APP_HOST in root .env
      FRONTEND_URL: http://${FRONTEND_HOST:-project.test}:${FRONTEND_PORT:-5173}
      # Sanctum Configuration
      SANCTUM_STATEFUL_DOMAINS: ${FRONTEND_HOST:-project.test}:${FRONTEND_PORT:-5173}
      SESSION_DOMAIN: .${APP_HOST:-project.test} # Note the leading dot for cookies
      # Reverb Configuration (Laravel backend connects to the 'reverb' service internally)
      BROADCAST_CONNECTION: reverb
      REVERB_APP_ID: ${REVERB_APP_ID}
      REVERB_APP_KEY: ${REVERB_APP_KEY}
      REVERB_APP_SECRET: ${REVERB_APP_SECRET}
      REVERB_HOST: reverb # Internal Docker DNS name, remains 'reverb'
      REVERB_PORT: 8080
      REVERB_SCHEME: http
    depends_on:
      - reverb # Laravel app depends on Reverb
    networks:
      - app_network
    restart: unless-stopped

  # Nginx Service to serve Laravel (and potentially proxy Reverb if needed, but here Reverb is direct)
  nginx:
    image: nginx:stable-alpine
    container_name: nginx
    ports:
      - "80:80"
    volumes:
      - ./vue-reverb-integration:/var/www/html
      # Mount the template, not the final config
      - ./docker/nginx/default.conf.template:/etc/nginx/conf.d/default.conf.template
    environment:
      APP_HOST: ${APP_HOST:-project.test} # Pass the desired host to Nginx
    entrypoint: /bin/sh -c "envsubst < /etc/nginx/conf.d/default.conf.template > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"
    depends_on:
      - laravel_app
    networks:
      - app_network
    restart: unless-stopped

  # Vue.js Frontend Service (Vite development server)
  vue_app:
    build:
      context: ./Client
      dockerfile: Dockerfile.vue
    container_name: vue_app
    ports:
      - "5173:5173" # Expose Vue app on port 5173
    volumes:
      - ./Client:/app
      - /app/node_modules # Prevent host node_modules from overwriting container's
    environment:
      NODE_ENV: development
      VITE_APP_NAME: Laravel
      # Frontend Reverb config (Frontend connects to project.test:8080 directly)
      VITE_REVERB_APP_KEY: ${REVERB_APP_KEY}
      VITE_REVERB_HOST: ${APP_HOST:-project.test} # Frontend connects to the external facing domain
      VITE_REVERB_PORT: 8080
      VITE_REVERB_SCHEME: http
      # Frontend Axios base URL for Laravel API
      VITE_AXIOS_BASE_URL: http://${APP_HOST:-project.test}
      VITE_BASE_URL: /
    networks:
      - app_network
    restart: unless-stopped

  # Reverb WebSocket Server
  reverb:
    build:
      context: ./vue-reverb-integration
      dockerfile: Dockerfile.reverb
    container_name: reverb
    ports:
      - "8080:8080" # Expose Reverb WebSocket port
    volumes:
      - ./vue-reverb-integration:/var/www/html
    environment:
      # Inherit common variables from the .env file in the same directory as docker-compose.yml
      APP_KEY: ${APP_KEY}
      APP_DEBUG: ${APP_DEBUG}
      REVERB_APP_ID: ${REVERB_APP_ID}
      REVERB_APP_KEY: ${REVERB_APP_KEY}
      REVERB_APP_SECRET: ${REVERB_APP_SECRET}
      # Reverb binds to 0.0.0.0 inside the container for external access
      REVERB_HOST: "0.0.0.0"
      REVERB_PORT: 8080
      REVERB_SCHEME: http
      BROADCAST_CONNECTION: reverb
      LOG_CHANNEL: stack
      LOG_LEVEL: debug
    command: php artisan reverb:start --host=0.0.0.0 --port=8080 # Explicitly set host/port
    networks:
      - app_network
    restart: unless-stopped

networks:
  app_network:
    driver: bridge